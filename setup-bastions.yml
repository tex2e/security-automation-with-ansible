---
- name: 踏み台サーバへの公開鍵の設定
  hosts: bastions
  gather_facts: no

  tasks:
    - name: SSH鍵生成
      openssh_keypair:
        path: "{{ private_key_path }}"
      delegate_to: localhost
      when: state is not defined

    - name: 公開鍵配布
      authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ lookup('file', private_key_path + '.pub') }}"
        state: "{{ state | default('present') }}"

    - name: "~/.ssh/configの設定"
      blockinfile:
        dest: "{{ lookup('env', 'HOME') }}/.ssh/config"
        marker: "# {mark} ANSIBLE MANAGED BLOCK: {{ item }}"
        content: |
          Host {{ item }}
            HostName {{ ansible_host }}
            User {{ ansible_user }}
            IdentityFile {{ private_key_path }}
        state: "{{ state | default('present') }}"
      delegate_to: localhost
      run_once: true                  # configファイルの同時編集を回避するため
      with_items: "{{ play_hosts }}"  # configファイルの同時編集を回避するため
